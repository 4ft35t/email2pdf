#!/usr/bin/env python

from subprocess import Popen, PIPE
from datetime import datetime
import email
import getopt
import os
import sys

def main(argv):
    inputFile = ''
    outputFile = ''
    try:
        opts, args = getopt.getopt(argv, "i:o:t", ["inputFile=","outputFile=", "timedOutputFile"])
    except getopt.GetoptError:
        print 'email2pdf.py -i <inputFile> -o <outputFile> [-t]'
        sys.exit(2)
    for opt, arg in opts:
        if opt in ("-i", "--inputFile"):
            inputFile = arg
        elif opt in ("-o", "--outputFile"):
            outputFile = arg
        elif opt in ("-t", "--timedOutputFile"):
            outputFile = datetime.now().strftime("%Y-%m-%d-%H-%M-%S-%f") + ".pdf"

    if inputFile.strip() == "-":
        data = ""
        for line in sys.stdin:
            data += line
    else:
        with open(inputFile, "r") as inputHandle:
            data = inputHandle.read()

    myEmail = email.message_from_string(data)
    payload = find_html_depth_first(myEmail)

    p = Popen(['wkhtmltopdf', '-q', '--load-error-handling', 'ignore', '--load-media-error-handling', 'ignore', '-', outputFile], stdin=PIPE)
    output = p.communicate(input = payload)

def find_html_depth_first(message):
    if message.is_multipart():
        for part in message.get_payload():
            value = find_html_depth_first(part)
            if value != False:
                return value
    elif message.get_content_type() == 'text/html':
        return message.get_payload(decode = True)
    else:
        return False

if __name__ == "__main__":
   main(sys.argv[1:])
